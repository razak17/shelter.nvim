name: Performance Benchmarks

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: true
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/shelter-core/target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Build shelter native library
        run: |
          cargo build --manifest-path crates/shelter-core/Cargo.toml --release
          mkdir -p lib
          cp crates/shelter-core/target/release/libshelter_core.so lib/

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Clone cloak.nvim
        run: git clone --depth 1 https://github.com/laytan/cloak.nvim /tmp/cloak.nvim

      - name: Run benchmarks
        run: |
          nvim --headless -u benchmarks/minimal_init.lua -l benchmarks/benchmark.lua
          echo "=== Benchmark Results ==="
          cat benchmark_results.json
          echo ""
          echo "=== Validating JSON ==="
          python3 -c "import json; json.load(open('benchmark_results.json'))" && echo "JSON is valid"

      - name: Update README with results
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          nvim --headless -u benchmarks/minimal_init.lua -l benchmarks/update_readme.lua 2>&1

      - name: Commit README changes
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update benchmark results [skip ci]"
          git push

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json
          retention-days: 30

      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('benchmark_results.json', 'utf8'));

            let body = '## Performance Benchmark Results\n\n';
            body += `Measured over ${results.metadata.iterations} iterations on Ubuntu:\n\n`;
            body += '| Lines | shelter.nvim | cloak.nvim | Difference |\n';
            body += '|-------|--------------|------------|------------|\n';

            const sizes = Object.keys(results.benchmarks).map(Number).sort((a, b) => a - b);
            for (const size of sizes) {
              const data = results.benchmarks[size];
              const shelter = `${data.shelter_ms.toFixed(2)} ms`;
              const cloak = data.cloak_ms ? `${data.cloak_ms.toFixed(2)} ms` : 'N/A';
              let diff = '';
              if (data.cloak_ms && data.shelter_ms > 0) {
                const ratio = data.cloak_ms / data.shelter_ms;
                if (ratio > 1) {
                  diff = `${ratio.toFixed(1)}x faster`;
                } else if (ratio < 1) {
                  diff = `${(1/ratio).toFixed(1)}x slower`;
                } else {
                  diff = 'same';
                }
              }
              body += `| ${size} | ${shelter} | ${cloak} | ${diff} |\n`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
