name: Performance Benchmarks

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: true
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/shelter-core/target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}

      - name: Build shelter native library
        run: |
          cargo build --manifest-path crates/shelter-core/Cargo.toml --release
          mkdir -p lib
          cp crates/shelter-core/target/release/libshelter_core.so lib/

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Clone cloak.nvim
        run: git clone --depth 1 https://github.com/laytan/cloak.nvim /tmp/cloak.nvim

      - name: Clone camouflage.nvim
        run: git clone --depth 1 https://github.com/zeybek/camouflage.nvim /tmp/camouflage.nvim


      - name: Run benchmarks
        run: |
          nvim --headless -u benchmarks/minimal_init.lua -l benchmarks/benchmark.lua
          echo "=== Benchmark Results ==="
          cat benchmark_results.json
          echo ""
          echo "=== Validating JSON ==="
          python3 -c "import json; json.load(open('benchmark_results.json'))" && echo "JSON is valid"

      - name: Update README with results
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          nvim --headless -u benchmarks/minimal_init.lua -l benchmarks/update_readme.lua 2>&1

      - name: Commit README changes
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --staged --quiet || git commit -m "docs: update benchmark results [skip ci]"
          git push

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.json
          retention-days: 30

      - name: Comment benchmark results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('benchmark_results.json', 'utf8'));

            const calcDiff = (shelter, other) => {
              if (!other || shelter <= 0) return '';
              const ratio = other / shelter;
              if (ratio > 1.05) return `${ratio.toFixed(1)}x faster`;
              if (ratio < 0.95) return `${(1/ratio).toFixed(1)}x slower`;
              return '~same';
            };

            const fmtMs = (v) => v != null ? `${v.toFixed(2)} ms` : 'N/A';

            const makeTable = (title, shelterKey, cloakKey, camouflageKey, pureLuaKey) => {
              let table = `#### ${title}\n\n`;
              table += '| Lines | shelter.nvim | cloak.nvim | camouflage.nvim | Pure Lua | vs cloak | vs camouflage | vs Pure Lua |\n';
              table += '|-------|--------------|------------|-----------------|----------|----------|---------------|-------------|\n';
              const sizes = Object.keys(results.benchmarks).map(Number).sort((a, b) => a - b);
              for (const size of sizes) {
                const data = results.benchmarks[size];
                const shelter = fmtMs(data[shelterKey]);
                const cloak = fmtMs(data[cloakKey]);
                const camouflage = fmtMs(data[camouflageKey]);
                const pureLua = fmtMs(data[pureLuaKey]);
                const cloakDiff = calcDiff(data[shelterKey], data[cloakKey]);
                const camoDiff = calcDiff(data[shelterKey], data[camouflageKey]);
                const pureLuaDiff = calcDiff(data[shelterKey], data[pureLuaKey]);
                table += `| ${size} | ${shelter} | ${cloak} | ${camouflage} | ${pureLua} | ${cloakDiff} | ${camoDiff} | ${pureLuaDiff} |\n`;
              }
              return table;
            };

            let body = '## Performance Benchmark Results\n\n';
            body += `Measured over ${results.metadata.iterations} iterations on Ubuntu:\n\n`;
            body += makeTable('Parsing Performance', 'shelter_parse_ms', 'cloak_parse_ms', 'camouflage_parse_ms', 'pure_lua_parse_ms') + '\n';
            body += makeTable('Preview Performance (Telescope)', 'shelter_preview_ms', 'cloak_preview_ms', 'camouflage_preview_ms', 'pure_lua_preview_ms') + '\n';
            body += makeTable('Edit Re-masking Performance', 'shelter_edit_ms', 'cloak_edit_ms', 'camouflage_edit_ms', 'pure_lua_edit_ms');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
